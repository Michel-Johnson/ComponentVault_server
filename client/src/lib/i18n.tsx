import { createContext, useContext, useEffect, useMemo, useState } from "react";

type Language = "en" | "zh";

type TranslationKey = keyof typeof translations.en;

const translations = {
  en: {
    appName: "ElectroVault",
    navInventory: "Inventory",
    navReports: "Reports",
    navSettings: "Settings",
    navNotifications: "Notifications",
    navUser: "User",
    languageEnglish: "English",
    languageChinese: "Chinese",
    languageLabel: "Language",
    searchPlaceholder: "Search components...",
    allCategories: "All Categories",
    addComponent: "Add Component",
    lowStockAlertTitle: "Low Stock Alert",
    lowStockAlertBody: "{count} components are running low on stock",
    statsTotalComponents: "Total Components",
    statsLowStock: "Low Stock Items",
    statsCategories: "Categories",
    statsTotalQuantity: "Total Quantity",
    tableComponent: "Component",
    tableCategory: "Category",
    tableQuantity: "Quantity",
    tableLocation: "Location",
    tableStatus: "Status",
    tableActions: "Actions",
    tableEmptyTitle: "No components found",
    tableEmptySubtitle: "Try adjusting your search or filter criteria.",
    statusOutOfStock: "Out of Stock",
    statusLowStock: "Low Stock",
    statusInStock: "In Stock",
    formAddTitle: "Add New Component",
    formEditTitle: "Edit Component",
    formComponentName: "Component Name",
    formCategory: "Category",
    formSelectCategory: "Select category",
    formQuantity: "Quantity",
    formLocation: "Location",
    formMinStock: "Minimum Stock Level",
    formDescription: "Description",
    formNamePlaceholder: "e.g., ATmega328P-PU",
    formLocationPlaceholder: "e.g., A1-B3",
    formDescriptionPlaceholder: "Component description and specifications...",
    buttonCancel: "Cancel",
    buttonSave: "Save",
    buttonAdd: "Add Component",
    buttonAdding: "Adding...",
    buttonUpdate: "Update Component",
    buttonUpdating: "Updating...",
    buttonDelete: "Delete Component",
    buttonDeleting: "Deleting...",
    toastSuccess: "Success",
    toastError: "Error",
    toastAdded: "Component added successfully",
    toastAddFailed: "Failed to add component",
    toastUpdated: "Component updated successfully",
    toastUpdateFailed: "Failed to update component",
    toastDeleted: "Component deleted successfully",
    toastDeleteFailed: "Failed to delete component",
    deleteWarning: "This action cannot be undone.",
    deletePrompt: 'Are you sure you want to delete "{name}"? This will permanently remove the component from your inventory.',
    loginTitle: "Sign in to continue",
    loginSubtitle: "Enter your credentials to access the warehouse",
    loginUsername: "Username",
    loginPassword: "Password",
    loginButton: "Sign In",
    loginError: "Invalid username or password",
    registerTitle: "Create an account",
    registerButton: "Register",
    haveAccount: "Already have an account?",
    needAccount: "Need an account?",
    reportsTitle: "Reports",
    reportsLowStockHeadline: "Low Stock Components",
    reportsLowStockSubtitle: "Review items that need replenishment soon.",
    reportsNoLowStock: "All components are above minimum stock levels.",
    reportsExport: "Download CSV",
    settingsTitle: "Settings",
    settingsAccount: "Account",
    settingsLogout: "Log out",
    settingsLanguageHint: "Choose your preferred language.",
    userGreeting: "Signed in as {username}",
    notFoundTitle: "404 Page Not Found",
    notFoundSubtitle: "Did you forget to add the page to the router?",
    notificationEmpty: "No notifications",
    notificationLowStockItem: "{name} is below minimum stock",
    userMenuProfile: "Profile",
    userMenuLogout: "Logout",
    adminPanel: "Admin Panel",
    adminUsers: "Users",
    adminGroups: "Groups",
    adminCreateUser: "Create User",
    adminCreateGroup: "Create Group",
    adminRole: "Role",
    adminMembers: "Members",
    adminDelete: "Delete",
    adminSave: "Save",
    adminUserWarehouse: "User Warehouse",
    adminAddToGroup: "Add to Group",
    adminNoUsers: "No users yet",
    adminNoGroups: "No groups yet",
    groupName: "Group Name",
    category_Resistors: "Resistors",
    category_Capacitors: "Capacitors",
    category_IntegratedCircuits: "Integrated Circuits",
    category_Transistors: "Transistors",
    category_Diodes: "Diodes",
    category_Connectors: "Connectors",
    category_Inductors: "Inductors",
    category_Switches: "Switches",
    category_Sensors: "Sensors",
    category_Other: "Other",
    warehousesTitle: "Warehouses",
    warehouseSelect: "Select warehouse",
    warehouseCreate: "Create Warehouse",
    warehouseNamePlaceholder: "My Warehouse",
    warehouseCreated: "Warehouse created",
    warehouseType: "Type",
    warehouseTypePersonal: "Personal",
    warehouseTypeGroup: "Group",
    warehouseLabelGroup: "Group",
    warehouseGroupSelect: "Select group",
    warehouseRename: "Rename warehouse",
    profileTitle: "Profile",
    profileUsername: "Username",
    profilePassword: "Password",
    profileSave: "Save changes",
    profileSaved: "Profile updated",
  },
  zh: {
    appName: "ElectroVault",
    navInventory: "库存",
    navReports: "报表",
    navSettings: "设置",
    navNotifications: "通知",
    navUser: "用户",
    languageEnglish: "英文",
    languageChinese: "中文",
    languageLabel: "语言",
    searchPlaceholder: "搜索元件...",
    allCategories: "全部分类",
    addComponent: "新增元件",
    lowStockAlertTitle: "库存预警",
    lowStockAlertBody: "有 {count} 个元件库存不足",
    statsTotalComponents: "元件总数",
    statsLowStock: "低库存项目",
    statsCategories: "分类数量",
    statsTotalQuantity: "库存总量",
    tableComponent: "元件",
    tableCategory: "分类",
    tableQuantity: "数量",
    tableLocation: "位置",
    tableStatus: "状态",
    tableActions: "操作",
    tableEmptyTitle: "未找到元件",
    tableEmptySubtitle: "试试调整搜索或筛选条件。",
    statusOutOfStock: "缺货",
    statusLowStock: "库存低",
    statusInStock: "有货",
    formAddTitle: "新增元件",
    formEditTitle: "编辑元件",
    formComponentName: "元件名称",
    formCategory: "分类",
    formSelectCategory: "选择分类",
    formQuantity: "数量",
    formLocation: "位置",
    formMinStock: "最低库存",
    formDescription: "描述",
    formNamePlaceholder: "例如：ATmega328P-PU",
    formLocationPlaceholder: "例如：A1-B3",
    formDescriptionPlaceholder: "元件描述及规格...",
    buttonCancel: "取消",
    buttonSave: "保存",
    buttonAdd: "新增元件",
    buttonAdding: "新增中...",
    buttonUpdate: "更新元件",
    buttonUpdating: "更新中...",
    buttonDelete: "删除元件",
    warehouseDelete: "删除仓库",
    warehouseDeleteConfirm: "确定要删除仓库「{name}」吗？",
    buttonDeleting: "删除中...",


    toastSuccess: "成功",
    toastError: "错误",
    toastAdded: "元件添加成功",
    toastAddFailed: "添加元件失败",
    toastUpdated: "元件更新成功",
    toastUpdateFailed: "更新元件失败",
    toastDeleted: "元件删除成功",
    toastDeleteFailed: "删除元件失败",
    deleteWarning: "此操作无法撤销。",
    deletePrompt: '确定要删除“{name}”吗？这会永久移除库存中的该元件。',
    loginTitle: "登录以继续",
    loginSubtitle: "输入账户密码访问仓库系统",
    loginUsername: "用户名",
    loginPassword: "密码",
    loginButton: "登录",
    loginError: "用户名或密码错误",
    registerTitle: "注册账户",
    registerButton: "注册",
    haveAccount: "已有账户？",
    needAccount: "需要一个账户？",
    reportsTitle: "报表",
    reportsLowStockHeadline: "低库存元件",
    reportsLowStockSubtitle: "查看需要尽快补货的物料。",
    reportsNoLowStock: "所有元件都高于最低库存。",
    reportsExport: "下载 CSV",
    settingsTitle: "设置",
    settingsAccount: "账户",
    settingsLogout: "退出登录",
    settingsLanguageHint: "选择偏好的显示语言。",
    userGreeting: "登录用户 {username}",
    notFoundTitle: "404 未找到页面",
    notFoundSubtitle: "是不是忘记在路由里添加这个页面了？",
    notificationEmpty: "暂无通知",
    notificationLowStockItem: "{name} 低于最低库存",
    userMenuProfile: "个人信息",
    userMenuLogout: "退出登录",
    adminPanel: "管理员面板",
    adminUsers: "用户",
    adminGroups: "群组",
    adminCreateUser: "新建用户",
    adminCreateGroup: "新建群组",
    adminRole: "角色",
    adminMembers: "成员",
    adminDelete: "删除",
    adminSave: "保存",
    adminUserWarehouse: "用户仓库",
    adminAddToGroup: "添加到群组",
    adminNoUsers: "当前没有用户",
    adminNoGroups: "当前没有群组",
    groupName: "群组名称",
    category_Resistors: "电阻",
    category_Capacitors: "电容",
    category_IntegratedCircuits: "集成电路",
    category_Transistors: "晶体管",
    category_Diodes: "二极管",
    category_Connectors: "连接器",
    category_Inductors: "电感",
    category_Switches: "开关",
    category_Sensors: "传感器",
    category_Other: "其他",
    warehousesTitle: "仓库",
    warehouseSelect: "选择仓库",
    warehouseCreate: "新建仓库",
    warehouseNamePlaceholder: "我的仓库",
    warehouseCreated: "已创建仓库",
    warehouseType: "类型",
    warehouseTypePersonal: "个人仓库",
    warehouseTypeGroup: "小组仓库",
    warehouseLabelGroup: "小组",
    warehouseGroupSelect: "选择小组",
    warehouseRename: "重命名仓库",
    profileTitle: "个人信息",
    profileUsername: "用户名",
    profilePassword: "密码",
    profileSave: "保存修改",
    profileSaved: "已更新",
  },
};

interface LanguageContextValue {
  language: Language;
  setLanguage: (language: Language) => void;
}

const LanguageContext = createContext<LanguageContextValue | undefined>(undefined);

export function LanguageProvider({ children }: { children: React.ReactNode }) {
  const [language, setLanguage] = useState<Language>(() => {
    if (typeof localStorage === "undefined") return "en";
    const stored = localStorage.getItem("ev-language") as Language | null;
    return stored ?? "en";
  });

  useEffect(() => {
    try {
      localStorage.setItem("ev-language", language);
    } catch (error) {
      // ignore storage errors
    }
  }, [language]);

  const value = useMemo(() => ({ language, setLanguage }), [language]);

  return <LanguageContext.Provider value={value}>{children}</LanguageContext.Provider>;
}

export function useLanguage() {
  const ctx = useContext(LanguageContext);
  if (!ctx) throw new Error("useLanguage must be used within LanguageProvider");
  return ctx;
}

export function useTranslation() {
  const { language } = useLanguage();

  return useMemo(
    () =>
      (key: TranslationKey, variables?: Record<string, string | number>) => {
        const template = translations[language]?.[key] ?? translations.en[key] ?? key;
        if (!variables) return template;

        return template.replace(/\{(\w+)\}/g, (_, v) => String(variables[v] ?? ""));
      },
    [language],
  );
}

export type { Language, TranslationKey };
export { translations };

